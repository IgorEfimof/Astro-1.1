<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon224.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ASTR 2.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Астрологический калькулятор PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            color: #e0e0e0;
            padding: 10px;
            -webkit-overflow-scrolling: touch;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 50%, #16213e 100%);
            overflow-y: auto;
        }

        /* Тема Луна (темная) - по умолчанию */
        body.theme-moon {
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
        }
        
        body.theme-moon .container {
            background: rgba(15, 15, 30, 0.8);
            border: 1px solid rgba(102, 126, 234, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        body.theme-moon .header h1 {
            background: linear-gradient(45deg, #a78bfa 0%, #7dd3fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        body.theme-moon .input-group {
            background: rgba(30, 30, 60, 0.5);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        body.theme-moon .input-group label {
            color: #c4b5fd;
        }
        
        body.theme-moon .input-group input,
        body.theme-moon .input-group select {
            background: rgba(50, 50, 80, 0.5);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: #e0e0e0;
        }
        
        body.theme-moon .calculate-btn {
            background: linear-gradient(45deg, #7c3aed 0%, #5b21b6 100%);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }
        
        body.theme-moon .chart-container,
        body.theme-moon .forecast {
            background: rgba(30, 30, 60, 0.5);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        body.theme-moon .planet-item,
        body.theme-moon .aspect-item {
            background: rgba(40, 40, 70, 0.5);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        body.theme-moon .chart-container h3,
        body.theme-moon .forecast h3 {
            color: #a78bfa;
        }

        /* Тема Солнце (светлая) */
        body.theme-sun {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
        }
        
        body.theme-sun .container {
            background: rgba(255, 255, 255, 0.8);
        }
        
        body.theme-sun .input-group {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.theme-sun .input-group input,
        body.theme-sun .input-group select {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #333;
        }
        
        body.theme-sun .calculate-btn {
            background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 100%);
        }
        
        body.theme-sun .chart-container,
        body.theme-sun .forecast {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.theme-sun .planet-item,
        body.theme-sun .aspect-item {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Тема Полнолуние (темно-серая) */
        body.theme-fullmoon {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
            color: #ecf0f1;
        }
        
        body.theme-fullmoon .container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        body.theme-fullmoon .input-group {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        body.theme-fullmoon .input-group input,
        body.theme-fullmoon .input-group select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #ecf0f1;
        }
        
        body.theme-fullmoon .calculate-btn {
            background: linear-gradient(45deg, #3498db 0%, #8e44ad 100%);
        }
        
        body.theme-fullmoon .chart-container,
        body.theme-fullmoon .forecast {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        body.theme-fullmoon .planet-item,
        body.theme-fullmoon .aspect-item {
            background: rgba(255, 255, 255, 0.08);
        }

        /* Тема Затмение (светло-серая) */
        body.theme-eclipse {
            background: linear-gradient(135deg, #636e72 0%, #b2bec3 50%, #dfe6e9 100%);
            color: #2d3436;
        }
        
        body.theme-eclipse .container {
            background: rgba(255, 255, 255, 0.7);
        }
        
        body.theme-eclipse .input-group {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.theme-eclipse .input-group input,
        body.theme-eclipse .input-group select {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #2d3436;
        }
        
        body.theme-eclipse .calculate-btn {
            background: linear-gradient(45deg, #6c5ce7 0%, #a29bfe 100%);
        }
        
        body.theme-eclipse .chart-container,
        body.theme-eclipse .forecast {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.theme-eclipse .planet-item,
        body.theme-eclipse .aspect-item {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Общие стили */
        .container {
            max-width: 100%;
            min-height: 100%;
            margin: 0 auto;
            border-radius: 16px;
            padding: 12px;
            display: block;
        }

        .theme-switcher {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .theme-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin: 0 6px;
            cursor: pointer;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .theme-option.active {
            border-color: #fff;
            transform: scale(1.1);
        }

        .theme-moon {
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
        }

        .theme-sun {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
        }

        .theme-fullmoon {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
            color: #ecf0f1;
        }

        .theme-eclipse {
            background: linear-gradient(135deg, #636e72 0%, #b2bec3 50%, #dfe6e9 100%);
            color: #2d3436;
        }

        .header {
            text-align: center;
            margin-bottom: 12px;
        }

        .header h1 {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-group {
            padding: 10px;
            border-radius: 10px;
        }

        .input-group.full-width {
            grid-column: 1 / -1;
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            font-size: 14px;
            border: none;
        }

        .city-select-wrapper {
            position: relative;
        }

        .city-select-wrapper i {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #a78bfa;
            font-size: 12px;
        }

        .calculate-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.5);
        }

        .loading {
            text-align: center;
            padding: 15px;
            display: none;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #667eea;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .content-area {
            display: block;
        }

        .results {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }

        .chart-container {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .chart-container h3 {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            font-size: 1rem;
        }

        .chart-container h3 i {
            margin-right: 6px;
            font-size: 14px;
        }

        .chart-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .planet-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .planet-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .aspects-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
            margin-top: 8px;
        }

        .aspect-item {
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.8rem;
        }

        .aspect-conjunction { border-left: 3px solid #FFD700; }
        .aspect-sextile { border-left: 3px solid #00FF00; }
        .aspect-square { border-left: 3px solid #FF4500; }
        .aspect-trine { border-left: 3px solid #00BFFF; }
        .aspect-opposition { border-left: 3px solid #8A2BE2; }

        .forecast {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .forecast h3 {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            font-size: 1rem;
        }

        .forecast h3 i {
            margin-right: 6px;
            font-size: 14px;
        }

        .forecast-text {
            line-height: 1.4;
            font-size: 0.85rem;
        }

        .error-message {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #ff6b6b;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: none;
            font-size: 0.8rem;
        }

        .house-system-selector {
            margin-top: 8px;
        }

        .house-system-selector select {
            width: 100%;
            padding: 6px;
            border-radius: 4px;
            background: rgba(50, 50, 80, 0.5);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: #e0e0e0;
            font-size: 0.8rem;
        }

        /* Медиа-запросы для iPad */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                max-width: 700px;
                margin: 0 auto;
            }
            
            .input-section {
                grid-template-columns: 1fr 1fr 1fr;
            }
            
            .planet-list {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        /* Медиа-запросы для iPhone в альбомной ориентации */
        @media (max-width: 767px) and (orientation: landscape) {
            .container {
                padding: 8px;
            }
            
            .header {
                margin-bottom: 8px;
            }
            
            .input-section {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
                margin-bottom: 8px;
            }
            
            .input-group {
                padding: 8px;
            }
            
            .calculate-btn {
                padding: 10px;
                margin-bottom: 8px;
            }
        }

        /* Улучшения для очень маленьких экранов */
        @media (max-width: 320px) {
            .container {
                padding: 8px;
            }
            
            .input-section {
                grid-template-columns: 1fr;
            }
            
            .planet-list {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body class="theme-moon">
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-star"></i> Астрологический калькулятор PRO</h1>
            <p>Профессиональные астрологические расчеты с реальными алгоритмами</p>
            
            <div class="theme-switcher">
                <div class="theme-option theme-moon active" data-theme="theme-moon" title="Тема Луна">
                    <i class="fas fa-moon"></i>
                </div>
                <div class="theme-option theme-sun" data-theme="theme-sun" title="Тема Солнце">
                    <i class="fas fa-sun"></i>
                </div>
                <div class="theme-option theme-fullmoon" data-theme="theme-fullmoon" title="Тема Полнолуние">
                    <i class="fas fa-circle"></i>
                </div>
                <div class="theme-option theme-eclipse" data-theme="theme-eclipse" title="Тема Затмение">
                    <i class="fas fa-circle-notch"></i>
                </div>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="input-section">
            <div class="input-group">
                <label><i class="fas fa-calendar-alt"></i> Дата рождения</label>
                <input type="date" id="birthDate" min="1900-01-01" value="1970-09-09">
            </div>
            <div class="input-group">
                <label><i class="fas fa-clock"></i> Время</label>
                <input type="time" id="birthTime" value="06:00">
            </div>
            <div class="input-group full-width">
                <label><i class="fas fa-map-marker-alt"></i> Место рождения</label>
                <div class="city-select-wrapper">
                    <select id="birthPlace">
                        <option value="Москва" data-lat="55.7558" data-lng="37.6173">Москва</option>
                        <option value="Санкт-Петербург" data-lat="59.9343" data-lng="30.3351">Санкт-Петербург</option>
                        <option value="Иваново" data-lat="56.9972" data-lng="40.9714" selected>Иваново</option>
                        <option value="Липецк" data-lat="52.6088" data-lng="39.5992">Липецк</option>
                        <option value="Екатеринбург" data-lat="56.8389" data-lng="60.6057">Екатеринбург</option>
                        <option value="Новосибирск" data-lat="55.0084" data-lng="82.9357">Новосибирск</option>
                        <option value="Казань" data-lat="55.8304" data-lng="49.0661">Казань</option>
                        <option value="Нижний Новгород" data-lat="56.2965" data-lng="43.9361">Нижний Новгород</option>
                        <option value="Челябинск" data-lat="55.1644" data-lng="61.4368">Челябинск</option>
                        <option value="Самара" data-lat="53.2415" data-lng="50.2212">Самара</option>
                        <option value="Омск" data-lat="54.9885" data-lng="73.3242">Омск</option>
                        <option value="Ростов-на-Дону" data-lat="47.2225" data-lng="39.7188">Ростов-на-Дону</option>
                        <option value="Уфа" data-lat="54.7351" data-lng="55.9587">Уфа</option>
                        <option value="Красноярск" data-lat="56.0153" data-lng="92.8932">Красноярск</option>
                        <option value="Воронеж" data-lat="51.6720" data-lng="39.1843">Воронеж</option>
                        <option value="Пермь" data-lat="58.0105" data-lng="56.2502">Пермь</option>
                        <option value="Волгоград" data-lat="48.7080" data-lng="44.5133">Волгоград</option>
                    </select>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="input-group full-width">
                <label><i class="fas fa-calendar-day"></i> Текущая дата</label>
                <input type="date" id="currentDate" value="2025-11-26">
            </div>
            <div class="input-group full-width">
                <label><i class="fas fa-chart-bar"></i> Система домов</label>
                <div class="house-system-selector">
                    <select id="houseSystem">
                        <option value="placidus">Плацидус</option>
                        <option value="koch">Кох</option>
                        <option value="equal">Равные дома</option>
                        <option value="whole">Целые знаки</option>
                    </select>
                </div>
            </div>
        </div>

        <button class="calculate-btn" onclick="calculateHoroscope()">
            <i class="fas fa-calculator"></i> Рассчитать гороскоп
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Выполняются астрологические расчеты...</p>
        </div>

        <div class="content-area">
            <div class="results" id="results" style="display: none;">
                <div class="chart-container">
                    <h3><i class="fas fa-chart-pie"></i> Натальная карта</h3>
                    <div class="chart-wrapper">
                        <canvas id="natalChart" width="250" height="250"></canvas>
                    </div>
                    <div class="planet-list" id="planetList"></div>
                </div>
                
                <div class="chart-container">
                    <h3><i class="fas fa-sync-alt"></i> Транзитные аспекты</h3>
                    <div class="aspects-grid" id="aspectsGrid"></div>
                </div>

                <div class="chart-container">
                    <h3><i class="fas fa-home"></i> Дома гороскопа</h3>
                    <div class="planet-list" id="housesList"></div>
                </div>
            </div>

            <div class="forecast" id="forecast" style="display: none;">
                <h3><i class="fas fa-crystal-ball"></i> Персональный прогноз</h3>
                <div class="forecast-text" id="forecastText"></div>
            </div>
        </div>
    </div>

    <script>
        // Функция для смены темы
        function changeTheme(theme) {
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`.theme-option[data-theme="${theme}"]`).classList.add('active');
            document.body.className = theme;
            localStorage.setItem('astrology-theme', theme);
        }

        // Астрономические константы и алгоритмы
        class AstroCalculator {
            constructor() {
                this.J2000 = 2451545.0; // Юлианская дата на 1 января 2000, 12:00 UT
                this.obliquityEcliptic = 23.4392911; // Наклон эклиптики на J2000.0
            }

            // Преобразование даты в юлианскую дату
            toJulianDate(date) {
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const hour = date.getHours() + date.getMinutes() / 60 + date.getSeconds() / 3600;

                let a = Math.floor((14 - month) / 12);
                let y = year + 4800 - a;
                let m = month + 12 * a - 3;

                let jd = day + Math.floor((153 * m + 2) / 5) + 365 * y + Math.floor(y / 4) 
                        - Math.floor(y / 100) + Math.floor(y / 400) - 32045;

                // Добавляем дробную часть дня
                jd += (hour - 12) / 24;

                return jd;
            }

            // Вычисление векового члена T (юлианские столетия от J2000.0)
            julianCenturies(jd) {
                return (jd - this.J2000) / 36525.0;
            }

            // Средняя аномалия Солнца
            meanSolarAnomaly(T) {
                return 357.52911 + 35999.05029 * T - 0.0001537 * T * T;
            }

            // Уравнение центра Солнца
            solarEquationOfCenter(T) {
                const M = this.meanSolarAnomaly(T) * Math.PI / 180;
                return (1.914602 - 0.004817 * T - 0.000014 * T * T) * Math.sin(M)
                     + (0.019993 - 0.000101 * T) * Math.sin(2 * M)
                     + 0.000289 * Math.sin(3 * M);
            }

            // Долгота Солнца
            solarLongitude(T) {
                const L0 = 280.46646 + 36000.76983 * T + 0.0003032 * T * T;
                const C = this.solarEquationOfCenter(T);
                return (L0 + C + 360) % 360;
            }

            // Положение Луны (упрощенный алгоритм)
            lunarLongitude(T) {
                // Средняя долгота Луны
                const Lp = 218.3164477 + 481267.88123421 * T 
                         - 0.0015786 * T * T + T * T * T / 538841 
                         - T * T * T * T / 65194000;

                // Средняя аномалия Луны
                const D = 297.8501921 + 445267.1114034 * T
                        - 0.0018819 * T * T + T * T * T / 545868
                        - T * T * T * T / 113065000;

                // Средняя аномалия Солнца
                const M = this.meanSolarAnomaly(T);

                // Средний аргумент широты
                const F = 93.2720950 + 483202.0175233 * T
                        - 0.0036539 * T * T - T * T * T / 3526000
                        + T * T * T * T / 863310000;

                // Периодические члены для долготы (основные)
                const terms = [
                    6.288774 * Math.sin(D * Math.PI / 180),
                    1.274027 * Math.sin((2 * F - D) * Math.PI / 180),
                    0.658314 * Math.sin(2 * F * Math.PI / 180),
                    0.213618 * Math.sin(2 * D * Math.PI / 180),
                    -0.185116 * Math.sin(M * Math.PI / 180),
                    -0.114332 * Math.sin(2 * F * Math.PI / 180)
                ];

                const correction = terms.reduce((sum, term) => sum + term, 0);
                return (Lp + correction + 360) % 360;
            }

            // Положение планеты по упрощенной модели
            planetLongitude(T, planetIndex) {
                const planetData = {
                    // Меркурий
                    0: {
                        L: 252.25032350,
                        coefficients: [
                            [4.402605, 26087.903141, 0]
                        ]
                    },
                    // Венера
                    1: {
                        L: 181.97909950,
                        coefficients: [
                            [3.176146, 10213.285546, 0]
                        ]
                    },
                    // Марс
                    2: {
                        L: -4.55343205,
                        coefficients: [
                            [1.753470, 5507.553240, 0]
                        ]
                    },
                    // Юпитер
                    3: {
                        L: 34.39644051,
                        coefficients: [
                            [0.599547, 529.690961, 0]
                        ]
                    },
                    // Сатурн
                    4: {
                        L: 49.95424423,
                        coefficients: [
                            [0.874016, 213.299086, 0]
                        ]
                    }
                };

                const planet = planetData[planetIndex];
                if (!planet) return 0;

                // Упрощенный расчет: средняя долгота + периодические члены
                let L = planet.L + planet.coefficients[0][1] * T;
                
                // Добавляем основные периодические члены
                planet.coefficients.forEach(coeff => {
                    L += coeff[0] * Math.sin(coeff[1] + coeff[2] * T);
                });

                return (L + 360) % 360;
            }

            // Расчет домов по системе Плацидуса
            calculateHouses(T, lat, lng, houseSystem) {
                const houses = [];
                const RAMC = (this.siderealTime(T, lng) * 15) % 360; // Right Ascension of MC
                
                // Упрощенный расчет куспидов домов
                for (let i = 1; i <= 12; i++) {
                    let angle;
                    switch (houseSystem) {
                        case 'placidus':
                            angle = this.placidusHouseAngle(i, RAMC, lat);
                            break;
                        case 'koch':
                            angle = this.kochHouseAngle(i, RAMC, lat);
                            break;
                        case 'equal':
                            angle = (RAMC + (i - 10) * 30) % 360;
                            break;
                        case 'whole':
                            angle = (Math.floor(RAMC / 30) * 30 + (i - 10) * 30) % 360;
                            break;
                        default:
                            angle = this.placidusHouseAngle(i, RAMC, lat);
                    }
                    
                    houses.push({
                        number: i,
                        position: (angle + 360) % 360,
                        sign: Math.floor(((angle + 360) % 360) / 30)
                    });
                }
                
                return houses;
            }

            // Сидерическое время
            siderealTime(T, longitude) {
                // Среднее сидерическое время в Гринвиче
                const GMST = 280.46061837 + 360.98564736629 * (T * 36525) 
                           + 0.000387933 * T * T - T * T * T / 38710000;
                
                // Местное сидерическое время
                return (GMST + longitude) / 15 % 24;
            }

            // Угол куспида дома по Плацидусу (упрощенно)
            placidusHouseAngle(house, RAMC, lat) {
                const baseAngles = [0, 30, 60, 90, 120, 150, 180, 210, 240, 270, 300, 330];
                const offset = lat / 60; // Упрощенная поправка на широту
                return (baseAngles[house - 1] + RAMC + offset * (house - 6.5)) % 360;
            }

            // Угол куспида дома по Коху (упрощенно)
            kochHouseAngle(house, RAMC, lat) {
                const baseAngle = RAMC + (house - 10) * 30;
                const latCorrection = Math.tan(lat * Math.PI / 180) * 2;
                return (baseAngle + latCorrection * (house - 6.5)) % 360;
            }
        }

        // Основные астрологические данные
        const planets = [
            { name: 'Солнце', symbol: '☉', color: '#FFD700', speed: 1.0 },
            { name: 'Луна', symbol: '☽', color: '#C0C0C0', speed: 13.2 },
            { name: 'Меркурий', symbol: '☿', color: '#CD7F32', speed: 4.1 },
            { name: 'Венера', symbol: '♀', color: '#FFC0CB', speed: 1.6 },
            { name: 'Марс', symbol: '♂', color: '#FF4500', speed: 0.5 },
            { name: 'Юпитер', symbol: '♃', color: '#FFA500', speed: 0.08 },
            { name: 'Сатурн', symbol: '♄', color: '#8B4513', speed: 0.03 },
            { name: 'Уран', symbol: '♅', color: '#00FFFF', speed: 0.01 },
            { name: 'Нептун', symbol: '♆', color: '#0000FF', speed: 0.006 },
            { name: 'Плутон', symbol: '♇', color: '#800080', speed: 0.004 }
        ];
        
        const zodiacSigns = [
            { name: 'Овен', symbol: '♈', element: 'Огонь', ruler: 'Марс', color: '#FF6B6B' },
            { name: 'Телец', symbol: '♉', element: 'Земля', ruler: 'Венера', color: '#4ECDC4' },
            { name: 'Близнецы', symbol: '♊', element: 'Воздух', ruler: 'Меркурий', color: '#FFD166' },
            { name: 'Рак', symbol: '♋', element: 'Вода', ruler: 'Луна', color: '#6A0572' },
            { name: 'Лев', symbol: '♌', element: 'Огонь', ruler: 'Солнце', color: '#FF9E64' },
            { name: 'Дева', symbol: '♍', element: 'Земля', ruler: 'Меркурий', color: '#06D6A0' },
            { name: 'Весы', symbol: '♎', element: 'Воздух', ruler: 'Венера', color: '#118AB2' },
            { name: 'Скорпион', symbol: '♏', element: 'Вода', ruler: 'Плутон', color: '#073B4C' },
            { name: 'Стрелец', symbol: '♐', element: 'Огонь', ruler: 'Юпитер', color: '#EF476F' },
            { name: 'Козерог', symbol: '♑', element: 'Земля', ruler: 'Сатурн', color: '#7209B7' },
            { name: 'Водолей', symbol: '♒', element: 'Воздух', ruler: 'Уран', color: '#3A86FF' },
            { name: 'Рыбы', symbol: '♓', element: 'Вода', ruler: 'Нептун', color: '#8338EC' }
        ];
        
        const aspects = [
            { name: 'Соединение', degrees: 0, orb: 8, symbol: '☌', color: '#FFD700', strength: 5 },
            { name: 'Секстиль', degrees: 60, orb: 5, symbol: '⚹', color: '#00FF00', strength: 3 },
            { name: 'Квадрат', degrees: 90, orb: 6, symbol: '□', color: '#FF4500', strength: 4 },
            { name: 'Трин', degrees: 120, orb: 6, symbol: '△', color: '#00BFFF', strength: 4 },
            { name: 'Оппозиция', degrees: 180, orb: 7, symbol: '☍', color: '#8A2BE2', strength: 5 }
        ];

        // Создаем экземпляр астрономического калькулятора
        const astroCalc = new AstroCalculator();

        // Функция для создания позиции планеты
        function createPlanetPosition(total, planetName) {
            const signIndex = Math.floor(total / 30) % 12;
            const degrees = Math.floor(total % 30);
            const minutes = Math.floor((total % 1) * 60);
            
            const planet = planets.find(p => p.name === planetName);
            return {
                total: total,
                sign: signIndex,
                degrees: degrees,
                minutes: minutes,
                symbol: planet ? planet.symbol : '?',
                color: planet ? planet.color : '#FFFFFF'
            };
        }

        // Функция для получения периода планеты
        function getPlanetPeriod(planetName) {
            const periods = {
                'Меркурий': 87.969, 'Венера': 224.701, 'Марс': 686.98,
                'Юпитер': 4332.589, 'Сатурн': 10759.22, 
                'Уран': 30685.4, 'Нептун': 60189, 'Плутон': 90553
            };
            return periods[planetName] || 365.25;
        }

        // Расчет положений планет с использованием астрономических алгоритмов
        function calculatePlanetPositions(date, time, lat, lng) {
            const positions = {};
            const birthDateTime = new Date(date + 'T' + time);
            
            // Для дат до 2000 года используем альтернативный расчет
            if (birthDateTime.getFullYear() < 2000) {
                return calculatePlanetPositionsPre2000(date, time, lat, lng);
            }
            
            const jd = astroCalc.toJulianDate(birthDateTime);
            const T = astroCalc.julianCenturies(jd);
            
            // Солнце
            const sunLon = astroCalc.solarLongitude(T);
            positions['Солнце'] = createPlanetPosition(sunLon, 'Солнце');
            
            // Луна
            const moonLon = astroCalc.lunarLongitude(T);
            positions['Луна'] = createPlanetPosition(moonLon, 'Луна');
            
            // Планеты земной группы
            for (let i = 0; i <= 2; i++) {
                const planetLon = astroCalc.planetLongitude(T, i);
                positions[planets[i + 2].name] = createPlanetPosition(planetLon, planets[i + 2].name);
            }
            
            // Внешние планеты (упрощенный расчет)
            const baseDate = new Date('2000-01-01T00:00:00');
            const timeDiff = birthDateTime.getTime() - baseDate.getTime();
            const daysSinceEpoch = timeDiff / (1000 * 60 * 60 * 24);
            
            for (let i = 5; i < planets.length; i++) {
                const planet = planets[i];
                const cycles = daysSinceEpoch / getPlanetPeriod(planet.name);
                let position = (cycles * 360) % 360;
                
                // Добавляем начальные позиции на J2000
                const initialPositions = {
                    'Юпитер': 34.35, 'Сатурн': 49.95, 'Уран': 314.96, 'Нептун': 304.78, 'Плутон': 238.96
                };
                position = (position + (initialPositions[planet.name] || 0)) % 360;
                
                positions[planet.name] = createPlanetPosition(position, planet.name);
            }
            
            return positions;
        }

        // Альтернативный расчет для дат до 2000 года
        function calculatePlanetPositionsPre2000(date, time, lat, lng) {
            const positions = {};
            const birthDateTime = new Date(date + 'T' + time);
            
            // Базовые позиции на 1970-01-01
            const baseDate = new Date('1970-01-01T00:00:00');
            const timeDiff = birthDateTime.getTime() - baseDate.getTime();
            const daysSince1970 = timeDiff / (1000 * 60 * 60 * 24);
            
            // Базовые позиции планет на 1970-01-01
            const basePositions1970 = {
                'Солнце': 280.0, 'Луна': 45.0, 'Меркурий': 320.0, 'Венера': 15.0, 
                'Марс': 120.0, 'Юпитер': 180.0, 'Сатурн': 240.0, 
                'Уран': 300.0, 'Нептун': 330.0, 'Плутон': 60.0
            };
            
            // Скорости планет (градусов в день)
            const speeds = {
                'Солнце': 0.9856, 'Луна': 13.176, 'Меркурий': 4.092, 
                'Венера': 1.602, 'Марс': 0.524, 'Юпитер': 0.083, 
                'Сатурн': 0.034, 'Уран': 0.012, 'Нептун': 0.006, 'Плутон': 0.004
            };
            
            // Расчет позиций
            planets.forEach(planet => {
                const basePos = basePositions1970[planet.name] || 0;
                const speed = speeds[planet.name] || 0;
                let position = (basePos + daysSince1970 * speed) % 360;
                if (position < 0) position += 360;
                
                positions[planet.name] = createPlanetPosition(position, planet.name);
            });
            
            return positions;
        }

        // Расчет транзитных положений
        function calculateTransitPositions(currentDate) {
            const positions = {};
            const transitDate = new Date(currentDate + 'T12:00:00');
            
            // Для дат до 2000 года используем альтернативный расчет
            if (transitDate.getFullYear() < 2000) {
                return calculatePlanetPositionsPre2000(currentDate, '12:00', 0, 0);
            }
            
            const jd = astroCalc.toJulianDate(transitDate);
            const T = astroCalc.julianCenturies(jd);
            
            // Солнце
            const sunLon = astroCalc.solarLongitude(T);
            positions['Солнце'] = createPlanetPosition(sunLon, 'Солнце');
            
            // Луна
            const moonLon = astroCalc.lunarLongitude(T);
            positions['Луна'] = createPlanetPosition(moonLon, 'Луна');
            
            // Остальные планеты (упрощенно)
            const baseDate = new Date('2000-01-01T00:00:00');
            const timeDiff = transitDate.getTime() - baseDate.getTime();
            const daysSinceEpoch = timeDiff / (1000 * 60 * 60 * 24);
            
            for (let i = 2; i < planets.length; i++) {
                const planet = planets[i];
                const cycles = daysSinceEpoch / getPlanetPeriod(planet.name);
                let position = (cycles * 360) % 360;
                
                const initialPositions = {
                    'Меркурий': 281.01, 'Венера': 272.15, 'Марс': 319.91,
                    'Юпитер': 34.35, 'Сатурн': 49.95, 'Уран': 314.96, 
                    'Нептун': 304.78, 'Плутон': 238.96
                };
                
                position = (position + (initialPositions[planet.name] || 0)) % 360;
                positions[planet.name] = createPlanetPosition(position, planet.name);
            }
            
            return positions;
        }

        // Расчет аспектов
        function calculateTransitAspects(natalPositions, transitPositions) {
            const foundAspects = [];
            const natalPlanetNames = Object.keys(natalPositions);
            const transitPlanetNames = Object.keys(transitPositions);
            
            for (let i = 0; i < natalPlanetNames.length; i++) {
                for (let j = 0; j < transitPlanetNames.length; j++) {
                    const natalPlanet = natalPlanetNames[i];
                    const transitPlanet = transitPlanetNames[j];
                    
                    if (natalPlanet === transitPlanet) continue;
                    
                    const angle = Math.abs(natalPositions[natalPlanet].total - transitPositions[transitPlanet].total);
                    const shortAngle = angle > 180 ? 360 - angle : angle;
                    
                    aspects.forEach(aspect => {
                        if (Math.abs(shortAngle - aspect.degrees) <= aspect.orb) {
                            foundAspects.push({
                                natalPlanet: natalPlanet,
                                transitPlanet: transitPlanet,
                                aspect: aspect.name,
                                symbol: aspect.symbol,
                                degrees: shortAngle.toFixed(1),
                                color: aspect.color,
                                strength: aspect.strength
                            });
                        }
                    });
                }
            }
            
            return foundAspects.sort((a, b) => b.strength - a.strength);
        }

        // Расчет домов гороскопа
        function calculateHouses(date, time, lat, lng, houseSystem) {
            const birthDateTime = new Date(date + 'T' + time);
            const jd = astroCalc.toJulianDate(birthDateTime);
            const T = astroCalc.julianCenturies(jd);
            
            return astroCalc.calculateHouses(T, lat, lng, houseSystem);
        }

        // Генерация прогноза на основе реальных аспектов
        function generateForecast(natalPositions, transitPositions, aspects, houses) {
            const sunSign = zodiacSigns[natalPositions['Солнце'].sign];
            const moonSign = zodiacSigns[natalPositions['Луна'].sign];
            const ascendant = houses[0];
            
            // Анализ важных аспектов
            const importantAspects = aspects.slice(0, 4);
            let aspectAnalysis = '';
            
            importantAspects.forEach(aspect => {
                const influence = analyzeAspectInfluence(aspect);
                aspectAnalysis += `<p>${influence}</p>`;
            });
            
            // Анализ текущих транзитов
            const transitAnalysis = analyzeTransits(transitPositions, natalPositions);
            
            const forecastText = `
                <p><strong>Солнечный знак:</strong> ${sunSign.symbol} ${sunSign.name} (${sunSign.element})</p>
                <p><strong>Лунный знак:</strong> ${moonSign.symbol} ${moonSign.name}</p>
                <p><strong>Восходящий знак:</strong> ${zodiacSigns[ascendant.sign].symbol} ${zodiacSigns[ascendant.sign].name}</p>
                
                <div style="margin-top: 12px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                    <strong>Ключевые аспекты:</strong><br>
                    ${aspectAnalysis || '<p>Гармоничные транзиты способствуют позитивным изменениям.</p>'}
                </div>
                
                <div style="margin-top: 12px;">
                    <strong>Общий прогноз:</strong><br>
                    ${transitAnalysis}
                </div>
                
                <div style="margin-top: 12px; font-size: 0.75rem; opacity: 0.8;">
                    <i class="fas fa-info-circle"></i> Прогноз основан на анализе текущих транзитов и их аспектов к натальной карте.
                </div>
            `;
            
            return forecastText;
        }

        function analyzeAspectInfluence(aspect) {
            const influences = {
                'Соединение': 'Интенсивное влияние, объединение энергий.',
                'Секстиль': 'Благоприятные возможности, гармоничное развитие.',
                'Квадрат': 'Вызовы и препятствия, требующие действий.',
                'Трин': 'Легкий поток энергии, удачные стечения обстоятельств.',
                'Оппозиция': 'Противоречия и необходимость баланса.'
            };
            
            return `${aspect.natalPlanet} ${aspect.symbol} ${aspect.transitPlanet} - ${influences[aspect.aspect] || 'Нейтральное влияние.'}`;
        }

        function analyzeTransits(transitPositions, natalPositions) {
            const analyses = [];
            
            // Анализ транзитов по важным планетам
            const importantTransits = ['Юпитер', 'Сатурн', 'Уран', 'Нептун', 'Плутон'];
            
            importantTransits.forEach(planet => {
                if (transitPositions[planet]) {
                    const transitSign = zodiacSigns[transitPositions[planet].sign];
                    const analysis = analyzePlanetTransit(planet, transitSign);
                    if (analysis) analyses.push(analysis);
                }
            });
            
            if (analyses.length > 0) {
                return analyses.join(' ');
            }
            
            return 'Текущий период характеризуется стабильностью и постепенным развитием. Благоприятное время для планирования и реализации давно задуманных проектов.';
        }

        function analyzePlanetTransit(planet, sign) {
            const analyses = {
                'Юпитер': `Транзит Юпитера через ${sign.name} приносит возможности для расширения и роста в сфере ${getSignDomain(sign.name)}.`,
                'Сатурн': `Сатурн в ${sign.name} требует дисциплины и ответственности в области ${getSignDomain(sign.name)}.`,
                'Уран': `Уран в ${sign.name} стимулирует неожиданные изменения и инновации в ${getSignDomain(sign.name)}.`,
                'Нептун': `Нептун в ${sign.name} усиливает интуицию и творческий потенциал в сфере ${getSignDomain(sign.name)}.`,
                'Плутон': `Плутон в ${sign.name} способствует глубоким трансформациям в области ${getSignDomain(sign.name)}.`
            };
            
            return analyses[planet];
        }

        function getSignDomain(signName) {
            const domains = {
                'Овен': 'инициатив и начинаний',
                'Телец': 'финансов и ценностей', 
                'Близнецы': 'коммуникации и обучения',
                'Рак': 'семьи и эмоций',
                'Лев': 'творчества и самовыражения',
                'Дева': 'работы и здоровья',
                'Весы': 'отношений и партнерств',
                'Скорпион': 'психологии и трансформаций',
                'Стрелец': 'философии и путешествий',
                'Козерог': 'карьеры и амбиций',
                'Водолей': 'инноваций и сообществ',
                'Рыбы': 'духовности и искусства'
            };
            
            return domains[signName] || 'личного развития';
        }

        // Отрисовка натальной карты
        function drawNatalChart(natalPositions, transitPositions, aspects, houses) {
            const canvas = document.getElementById('natalChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = 125;
            const centerY = 125;
            const radius = 100;
            
            ctx.clearRect(0, 0, 250, 250);
            
            // Рисуем зодиакальный круг
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Знаки зодиака
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            for (let i = 0; i < 12; i++) {
                const angle = (i * 30 - 90) * Math.PI / 180;
                const x = centerX + Math.cos(angle) * (radius + 12);
                const y = centerY + Math.sin(angle) * (radius + 12);
                
                ctx.fillStyle = zodiacSigns[i].color;
                ctx.fillText(zodiacSigns[i].symbol, x, y);
            }
            
            // Дома
            ctx.strokeStyle = 'rgba(102, 126, 234, 0.5)';
            ctx.lineWidth = 1;
            
            houses.forEach((house, i) => {
                const angle = (house.position - 90) * Math.PI / 180;
                const x1 = centerX + Math.cos(angle) * (radius - 25);
                const y1 = centerY + Math.sin(angle) * (radius - 25);
                const x2 = centerX + Math.cos(angle) * radius;
                const y2 = centerY + Math.sin(angle) * radius;
                
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            });
            
            // Натальные планеты
            planets.forEach((planet, index) => {
                const pos = natalPositions[planet.name];
                if (!pos) return;
                
                const angle = (pos.total - 90) * Math.PI / 180;
                const distance = radius - 35 - index * 4;
                const x = centerX + Math.cos(angle) * distance;
                const y = centerY + Math.sin(angle) * distance;
                
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fillStyle = planet.color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 10px Arial';
                ctx.fillText(planet.symbol, x, y);
            });
            
            // Транзитные планеты
            planets.forEach((planet, index) => {
                const pos = transitPositions[planet.name];
                if (!pos) return;
                
                const angle = (pos.total - 90) * Math.PI / 180;
                const distance = radius + 15 + index * 4;
                const x = centerX + Math.cos(angle) * distance;
                const y = centerY + Math.sin(angle) * distance;
                
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fillStyle = planet.color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, 2 * Math.PI);
                ctx.setLineDash([2, 2]);
                ctx.strokeStyle = planet.color;
                ctx.lineWidth = 1;
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 9px Arial';
                ctx.fillText(planet.symbol, x, y);
            });
        }

        // Валидация ввода
        function validateInput() {
            const birthDate = document.getElementById('birthDate').value;
            const currentDate = document.getElementById('currentDate').value;
            const birthPlace = document.getElementById('birthPlace').value.trim();
            
            if (!birthDate) {
                showError('Пожалуйста, введите дату рождения');
                return false;
            }
            
            if (!currentDate) {
                showError('Пожалуйста, введите текущую дату');
                return false;
            }
            
            if (!birthPlace) {
                showError('Пожалуйста, выберите место рождения');
                return false;
            }
            
            const birth = new Date(birthDate);
            const current = new Date(currentDate);
            
            if (isNaN(birth.getTime())) {
                showError('Некорректная дата рождения');
                return false;
            }
            
            if (isNaN(current.getTime())) {
                showError('Некорректная текущая дата');
                return false;
            }
            
            if (birth > current) {
                showError('Дата рождения не может быть в будущем');
                return false;
            }
            
            hideError();
            return true;
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Получение координат выбранного города
        function getSelectedCityCoordinates() {
            const select = document.getElementById('birthPlace');
            const selectedOption = select.options[select.selectedIndex];
            return {
                name: selectedOption.value,
                lat: parseFloat(selectedOption.getAttribute('data-lat')),
                lng: parseFloat(selectedOption.getAttribute('data-lng'))
            };
        }

        // Основная функция расчета
        function calculateHoroscope() {
            if (!validateInput()) return;
            
            const birthDate = document.getElementById('birthDate').value;
            const birthTime = document.getElementById('birthTime').value;
            const currentDate = document.getElementById('currentDate').value;
            const cityData = getSelectedCityCoordinates();
            const houseSystem = document.getElementById('houseSystem').value;
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('forecast').style.display = 'none';
            
            setTimeout(() => {
                try {
                    const natalPositions = calculatePlanetPositions(birthDate, birthTime, cityData.lat, cityData.lng);
                    const transitPositions = calculateTransitPositions(currentDate);
                    const calculatedAspects = calculateTransitAspects(natalPositions, transitPositions);
                    const houses = calculateHouses(birthDate, birthTime, cityData.lat, cityData.lng, houseSystem);
                    const forecast = generateForecast(natalPositions, transitPositions, calculatedAspects, houses);
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('results').style.display = 'block';
                    document.getElementById('forecast').style.display = 'block';
                    
                    // Заполнение списка планет
                    const planetList = document.getElementById('planetList');
                    planetList.innerHTML = '';
                    
                    planets.forEach(planet => {
                        const pos = natalPositions[planet.name];
                        if (!pos) return;
                        
                        const sign = zodiacSigns[pos.sign];
                        const div = document.createElement('div');
                        div.className = 'planet-item';
                        div.innerHTML = `
                            <span class="planet-name">${planet.symbol} ${planet.name}</span>
                            <span class="planet-position">${sign.symbol} ${pos.degrees}°${pos.minutes}'</span>
                        `;
                        planetList.appendChild(div);
                    });
                    
                    // Отображение аспектов
                    const aspectsGrid = document.getElementById('aspectsGrid');
                    aspectsGrid.innerHTML = '';
                    
                    calculatedAspects.slice(0, 6).forEach(aspect => {
                        const div = document.createElement('div');
                        div.className = `aspect-item aspect-${aspect.aspect.toLowerCase()}`;
                        div.innerHTML = `
                            <div><strong>${aspect.transitPlanet} ${aspect.symbol} ${aspect.natalPlanet}</strong></div>
                            <div>${aspect.aspect} ${aspect.degrees}°</div>
                        `;
                        aspectsGrid.appendChild(div);
                    });
                    
                    // Отображение домов
                    const housesList = document.getElementById('housesList');
                    housesList.innerHTML = '';
                    
                    houses.forEach(house => {
                        const sign = zodiacSigns[house.sign];
                        const div = document.createElement('div');
                        div.className = 'planet-item';
                        div.innerHTML = `
                            <span class="planet-name">Дом ${house.number}</span>
                            <span class="planet-position">${sign.symbol} ${sign.name}</span>
                        `;
                        housesList.appendChild(div);
                    });
                    
                    // Отрисовка карты
                    drawNatalChart(natalPositions, transitPositions, calculatedAspects, houses);
                    
                    // Отображение прогноза
                    document.getElementById('forecastText').innerHTML = forecast;
                    
                } catch (error) {
                    console.error('Ошибка при расчете гороскопа:', error);
                    document.getElementById('loading').style.display = 'none';
                    showError('Произошла ошибка при расчете гороскопа. Пожалуйста, проверьте введенные данные и попробуйте снова.');
                }
            }, 100);
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            document.getElementById('currentDate').value = today.toISOString().split('T')[0];
            
            // Устанавливаем минимальную дату как 1900-01-01
            document.getElementById('birthDate').min = '1900-01-01';
            
            const savedTheme = localStorage.getItem('astrology-theme') || 'theme-moon';
            changeTheme(savedTheme);
            
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    changeTheme(theme);
                });
            });
            
            // Предотвращаем масштабирование на iOS
            document.addEventListener('touchmove', function(e) {
                if (e.scale !== 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        });
    </script>
</body>
</html>
